---
title: "Figures"
author: "Lauren Kennedy"
date: "09/05/2022"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(ggplot2)
library(tidyverse)
library(forcats)
library(here)

res_list <- readRDS(here('02-super popn approach/experiment4_SAE/03-data/res_list.rds'))

indv_all_tab = res_list$indv_all_tab
popn_indv_tab = res_list$popn_indv_tab
model_sae_X1_tab = res_list$model_sae_X1_tab
model_sae_X2_tab = res_list$model_sae_X2_tab
model_sae_X3_tab = res_list$model_sae_X3_tab
model_sae_X4_tab = res_list$model_sae_X4_tab
```

## ELPD and individual interval score

Will likely get replaced by earlier simulation

```{r}
corr_indiv_intervalscore <- popn_indv_tab %>%
  pivot_longer(cols = c("elpd_loo","wtdElpd_loo"), names_to = "type", values_to = "model_score")%>%
  mutate(type = factor(type),
         type = fct_recode(type, `LOO` = "elpd_loo", `WTD LOO` = "wtdElpd_loo"))%>%
  group_by(type)%>%
  summarise(cor_val = paste0("cor: ",round(cor(model_score, ind_intervalScr_mean),2)))%>%
  mutate(xloc = c(-275,-5000),yloc = c(8.5,8.5))

popn_indv_tab %>%
  pivot_longer(cols = c("elpd_loo","wtdElpd_loo"), names_to = "type", values_to = "model_score")%>%
  mutate(type = factor(type),
        type = fct_recode(type, `LOO` = "elpd_loo", `WTD LOO` = "wtdElpd_loo"))%>%
  ggplot(., aes(x = model_score, y = ind_intervalScr_mean))+
    geom_point(alpha = .5, aes( colour = model))+
#    geom_line(aes(group = iteration), method = "lm", se = FALSE, colour = "black", stat = "smooth", alpha = .3)+
    ggthemes::scale_color_colorblind()+
    geom_text(
    data    = corr_indiv_intervalscore,
    mapping = aes(x = xloc, y = yloc, label = cor_val))+
    facet_grid(.~type, scales = "free")+
  xlab("Model Score")+ ylab("Mean Individual Interval Score")+
  theme(legend.position = "bottom",
        legend.title = element_blank())
```


## ELPD and population MRP interval score

Will likely get replaced by earlier simulation

```{r}
corr_popn_intervalscore <- popn_indv_tab %>%
  pivot_longer(cols = c("elpd_loo","wtdElpd_loo"), names_to = "type", values_to = "model_score")%>%
  mutate(type = factor(type),
         type = fct_recode(type, `LOO` = "elpd_loo", `WTD LOO` = "wtdElpd_loo"))%>%
  group_by(type)%>%
  summarise(cor_val = paste0("cor: ",round(cor(model_score, popn_intervalScr),2)))%>%
  mutate(xloc = c(-275,-5000),yloc = c(2,2))


popn_indv_tab %>%
  pivot_longer(cols = c("elpd_loo","wtdElpd_loo"), names_to = "type", values_to = "model_score")%>%
  mutate(type = factor(type),
         type = fct_recode(type, `LOO` = "elpd_loo", `WTD LOO` = "wtdElpd_loo"))%>%
  ggplot(., aes(x = model_score, y =    popn_intervalScr))+
  geom_point(alpha = .5, aes( colour = model))+
#  geom_line(aes(group = iteration), method = "lm", se = FALSE, colour = "black", stat = "smooth", alpha = .3)+
  geom_text(data  = corr_popn_intervalscore,
    mapping = aes(x = xloc, y = yloc, label = cor_val))+
  ggthemes::scale_color_colorblind()+
  facet_grid(.~type, scales = "free")+
  xlab("Model Score")+ ylab("Population MRP Interval Score")+
  theme(legend.position = "bottom",
        legend.title = element_blank())
```


## Difference between priors - full model

This one compares the AR prior against the non-AR prior for the full model. Axes are arranged so points in the top right quadrant are where ELPD and Interval Score agree. I thought the 3, 4 facets were kind of interesting because there's barely an improvement from the AR prior but the elpd seems relatively positive.

```{r}
saeX1_clean <- model_sae_X1_tab %>%
  rename(group = X1, elpdmean_sae = elpd_mean_X1sae, intervalScr_sae = intervalScr_X1sae)%>%
  select(group, iteration, intervalScr_sae, elpdmean_sae,model)%>%
  mutate(sae = "X1")

saeX2_clean <- model_sae_X2_tab %>%
  rename(group = X2, elpdmean_sae = elpd_mean_X2sae, intervalScr_sae = intervalScr_X2sae)%>%
  select(group, iteration, intervalScr_sae, elpdmean_sae,model)%>%
  mutate(sae = "X2")

saeX3_clean <- model_sae_X3_tab %>%
  rename(group = X3, elpdmean_sae = elpd_mean_X3sae, intervalScr_sae = intervalScr_X3sae)%>%
  select(group, iteration, intervalScr_sae, elpdmean_sae,model)%>%
  mutate(sae = "X3")

saeX4_clean <- model_sae_X4_tab %>%
  rename(group = X4, elpdmean_sae = elpd_mean_X4sae, intervalScr_sae = intervalScr_X4sae)%>%
  select(group, iteration, intervalScr_sae, elpdmean_sae,model)%>%
  mutate(sae = "X4")

sae_clean <- rbind(saeX1_clean,saeX2_clean, saeX3_clean, saeX4_clean)%>%
  mutate(full_model = grepl("X1 + X2 + X3 + X4",model, fixed = TRUE),
         ar_prior = grepl("*",model, fixed = TRUE))

colour_palette_var  =  c( `X1 + X2 + X3` = "#ef6548",
               `X1 + X2 + X3 + X4` = "#014636", `X1 + X2 + X4 ` ="#02818a", `X2 + X3 + X4` = "#67a9cf", 
               `X1 + X3` = "#fed976",
               `X1 + X3 + X4` = "#f768a1")


sae_clean %>%
  select(-ar_prior)%>%
  filter(full_model, sae == "X4")%>%
  pivot_wider(names_from = model, values_from = c(intervalScr_sae, elpdmean_sae), names_sep = "-")%>%
  mutate(elpd_diff = (`elpdmean_sae-*X1 + X2 + X3 + X4`-`elpdmean_sae-X1 + X2 + X3 + X4`), # positive is favours * model
         intscr_diff = -(`intervalScr_sae-*X1 + X2 + X3 + X4`-`intervalScr_sae-X1 + X2 + X3 + X4`))%>% #postiive favours * model 
  ggplot(., aes(x = elpd_diff, y = intscr_diff))+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_point(alpha = .3)+
  facet_wrap(.~group)+
  ggtitle("AR Prior vs non-AR prior")+
  xlab("ELPD (AR prior)- ELPD (non-AR prior)")+
  ylab("1- (Interval Score (AR prior)- Interval Score (non-AR prior))")+
  theme(plot.title = element_text(hjust = 0.5))

```

## Difference between variables - SAE

### Focus on X1-X3


Then I took a look into our different models (excluding the AR prior). I looked at the X1-X3 variables first. I added a rug plot on either side to highlight the distributional differences (I kept losing track). I think this broadly shows what we had discussed previously, but I think the second row, fifth tab, orange colour (X2 only model) needs to be investigated - what's with that linear trend? But essentially, it highlight a) that different variables aren't properly reflected with ELPD and b) the x2 only model isn't so bad when looking specifically at X2 level predictions. 

```{r}

 sae_clean %>%
  select(-full_model)%>%
  filter(!ar_prior, sae != "X4")%>%
  mutate(full_model = grepl("X1 + X2 + X3 + X4",model, fixed = TRUE))%>%
  ggplot(., aes(x = elpdmean_sae, y = intervalScr_sae, colour = model))+
  geom_point(alpha=.6)+
  facet_grid(sae~group)+
  scale_color_manual(values = colour_palette_var)+
  geom_rug(alpha=.3)+
  theme(legend.position = "bottom",
        legend.title = element_blank())+
   xlab("Mean SAE ELDP") + ylab("Interval Score at SAE")


```


### Focus on X4

When we look at the X4 small area estimation, we see a similar two clouds, but the models change, indicating that the goodness differs based on the small area being estimated. Importantly, the cloud is only on the y direction, and not the x-direction, suggesting that ELPD is again not sensitive to this, even when we calculate it at the small area level. 



```{r}

sae_clean %>%
  select(-full_model)%>%
  filter(!ar_prior, sae == "X4")%>%
  mutate(full_model = grepl("X1 + X2 + X3 + X4",model, fixed = TRUE) 
         )%>%
  ggplot(., aes(x = elpdmean_sae, y = intervalScr_sae, colour = model))+
  geom_point(alpha=.6)+
  facet_wrap(.~group)+
  scale_color_manual(values = colour_palette_var)+
  geom_rug(alpha=.3)+
  theme(legend.position = "bottom",
        legend.title = element_blank())+
  xlab("Mean SAE ELDP") + ylab("Interval Score at SAE")

```

