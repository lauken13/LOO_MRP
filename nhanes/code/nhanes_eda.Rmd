---
title: "NHANES data exploration"
author: "Swen Kuh"
date: "2022-08-18"
output:
  pdf_document: default
  html_document: default
---
We run into singularity issues for models lme1-lme4, and the warning stops for model lme5 (after removing pregnancy indicator (too many missing obs.), secondhand smoke exposure, potassium intake level, smoking tobacco/cigarette and sodium level). I removed the variables based on 'insignificance' of the variable or zero variance (singularity issue). When using the urine subsample, we run into the same issue again. There is no warning issued after we remove the education variable. But should we? I didn't want to remove sodium level at first (I'm interested in the effects) but in the context of MRP, we are more concerned of predicting than inference of the effects? 

The data cleaning code is shown at the bottom of the document. 

## Running the models - lme4
```{r, warning=F, echo=F, error=F, message=F}
library(brms)
library(lme4)
library(tidyverse)
load(here::here('nhanes/nhanes_res.RData'))
```

```{r}
# full model
nhmodel_lme1 = glmer(high_bp ~ (1|age) + (1|ethnicity) + gender + (1|educ) +
                       (1|marital_status) + phys_act + overweight + (1|dep_severity) +
                       (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep +
                       (1|pov_level) + smk_tobcig + smk2_exp +
                       (1|sodium_lvl) + (1|potassium_lvl), data = nhdata, family="binomial")

# # remove smk2_exp
# nhmodel_lme2 = glmer(high_bp ~ (1|age) + (1|ethnicity) + gender + (1|educ) +
#                         (1|marital_status) + phys_act + overweight + (1|dep_severity) +
#                         (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep +
#                         (1|pov_level) + smk_tobcig  +
#                         (1|sodium_lvl) + (1|potassium_lvl), data = nhdata, family="binomial")

# # remove potassium level
# nhmodel_lme3 = glmer(high_bp ~ (1|age) + (1|ethnicity) + gender + (1|educ) +
#                        (1|marital_status) + phys_act + overweight + (1|dep_severity) +
#                        (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep +
#                        (1|pov_level) + smk_tobcig  + (1|sodium_lvl) , data = nhdata, family="binomial")
#
# # remove smk_tobcig
# nhmodel_lme4 = glmer(high_bp ~ (1|age) + (1|ethnicity) + gender + (1|educ) +
#                        (1|marital_status) + phys_act + overweight + (1|dep_severity) +
#                        (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep +
#                        (1|pov_level) + (1|sodium_lvl) , data = nhdata, family="binomial")

# remove sodium level - no more singularity error -  6786 observations (after na.omit) 
nhmodel_lme5 = glmer(high_bp ~ (1|age) + (1|ethnicity) + gender + (1|educ) +
                       (1|marital_status) + phys_act + overweight + (1|dep_severity) +  
                       (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep + 
                       (1|pov_level) , data = nhdata, family="binomial")

summary(nhmodel_lme5)
```

```{r}
# subsample - 2220 observations (after na.omit, 2224) and dropping 4 with weights = 0 
nhmodel_lme5_sub = glmer(high_bp ~ (1|age) + (1|ethnicity) + gender +
                        (1|marital_status) + phys_act + overweight + (1|dep_severity) +  
                       (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep + 
                       (1|pov_level) , data = nh_sub, family="binomial")
summary(nhmodel_lme5_sub)

# MSE
( pred.lme = predict(nhmodel_lme5, type="response") %>% 
  as.data.frame(.) %>% 
  mutate(pred.bin = ifelse(. >= 0.5, 1, 0), 
         truth = as.numeric(nhdata$high_bp), 
         bias = pred.bin - truth) %>% 
  summarise(mse = mean(bias^2)) )

# incl prob model 
( nhmodel_sub_inclprob = lmer(log(incl_prob) ~ (1|age) + (1|ethnicity) + gender + (1|educ) + 
                                    (1|marital_status) +  phys_act + overweight + (1|dep_severity) +  
                                    (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep + 
                                    (1|pov_level) , data = nh_sub) )
```


## Running the models - brms
```{r}
## brms ####
# nhmodel = brm(high_bp ~ (1|age) + (1|ethnicity) + gender + (1|educ) +
#                 (1|marital_status) + phys_act + overweight + (1|dep_severity) +  
#                 (1|BMI_range) + (1|alc_exc) + (1|diabetes) + trb_sleep + 
#                 (1|pov_level), 
#               data = nhdata, 
#               seed = 2345,
#               chain = 2,
#               backend = "cmdstanr",
#               family = bernoulli(link = "logit"), 
#               control = list(adapt_delta = 0.9)) 

# MSE 
( pred.brms = predict(nhmodel)[,1] %>% 
    as.data.frame(.) %>% 
    mutate(pred.bin = ifelse(. >= 0.5, 1, 0), 
           truth = as.numeric(nhdata$high_bp), 
           bias = pred.bin - truth) %>% 
    summarise(mse = mean(bias^2)) )

# nhmodel_urn = brm(high_bp ~ (1|age) + (1|ethnicity) + gender + (1|educ) +
#                     (1|marital_status) + phys_act + overweight + (1|dep_severity) +
#                     (1|BMI_range) + (1|alc_exc) + (1|diabetes) + (1|trb_sleep) +
#                     (1|pov_level) ,
#                   data = nh_sub,
#                   seed = 2345,
#                   backend = "cmdstanr",
#                   family = bernoulli(link = "logit"),
#                   control = list(adapt_delta = 0.9))

# MSE
( pred.brms.urn = predict(nhmodel_urn)[,1] %>% 
    as.data.frame(.) %>% 
    mutate(pred.bin = ifelse(. >= 0.5, 1, 0), 
           truth = as.numeric(nh_sub$high_bp), 
           bias = pred.bin - truth) %>% 
    summarise(mse = mean(bias^2)) )
```





